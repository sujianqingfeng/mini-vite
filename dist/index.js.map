{"version":3,"sources":["../src/node/cli.ts","../src/node/server/index.ts","../src/node/optimizer/index.ts","../src/node/constants.ts","../src/node/optimizer/scanPlugin.ts","../src/node/optimizer/preBundlePlugin.ts"],"sourcesContent":["import cac from \"cac\"\n\nimport { startDevServer } from \"./server/index\"\n\nconst cli = cac()\n\ncli\n  .command(\"[root]\", \"Run the development server\")\n  .alias(\"serve\")\n  .alias(\"dev\")\n  .action(async () => {\n    await startDevServer()\n  })\n\ncli.help()\n\ncli.parse()\n","// connect是一个具有中间件的node框架\n// 可以作为服务器 也可以接入具有中间件的框架当中\nimport connect from \"connect\"\n\n// 命令行着色工具\nimport { blue, green } from \"picocolors\"\n\nimport { optimizer } from \"../optimizer/index\"\n\nexport async function startDevServer() {\n  const app = connect()\n  const root = process.cwd()\n  console.log(\"root\", root)\n\n  const startTime = Date.now()\n\n  app.listen(3000, async () => {\n    await optimizer(root)\n\n    console.log(\n      green(\"No-Bundle Server start!\"),\n      `耗时：${Date.now() - startTime}ms`\n    )\n\n    console.log(`本地访问路径：${blue(\"http://localhost:3000\")}`)\n  })\n}\n","import path from \"path\"\nimport { build } from \"esbuild\"\n\nimport { green } from \"picocolors\"\nimport { scanPlugin } from \"./scanPlugin\"\nimport { PRE_BUNDLE_DIR } from \"../constants\"\nimport { preBundlePlugin } from \"./preBundlePlugin\"\n\nexport async function optimizer(root: string) {\n  // 1.确定入口\n  const entry = path.resolve(root, \"src/main.tsx\")\n\n  // 2.从入口扫描依赖\n  const deps = new Set<string>()\n\n  await build({\n    entryPoints: [entry],\n    bundle: true,\n    write: false,\n    plugins: [scanPlugin(deps)],\n  })\n\n  console.log(`\n  ${green(\"需要预构建的依赖\")}:\\n\n ${[...deps]\n   .map(green)\n   .map((item) => ` ${item}`)\n   .join(\"\\n\")}\n  `)\n\n  // 3.预构建依赖\n\n  await build({\n    entryPoints: [...deps],\n    write: true,\n    bundle: true,\n    format: \"esm\",\n    splitting: true,\n    outdir: path.resolve(root, PRE_BUNDLE_DIR),\n    plugins: [preBundlePlugin(deps)],\n  })\n}\n","import path from \"path\"\n\n// 不处理\nexport const EXTERNAL_TYPES = [\n  \"css\",\n  \"less\",\n  \"sass\",\n  \"scss\",\n  \"styl\",\n  \"stylus\",\n  \"pcss\",\n  \"postcss\",\n  \"vue\",\n  \"svelte\",\n  \"marko\",\n  \"astro\",\n  \"png\",\n  \"jpe?g\",\n  \"gif\",\n  \"svg\",\n  \"ico\",\n  \"webp\",\n  \"avif\",\n]\n\n// 裸模块  就是没有绝对路径或者相对路径\nexport const BARE_IMPORT_RE = /^[\\w@][^:]/\n\n// 预构建存放的位置\nexport const PRE_BUNDLE_DIR = path.join(\"node_modules\", \".m-vite\")\n","import { Plugin } from \"esbuild\"\nimport { BARE_IMPORT_RE, EXTERNAL_TYPES } from \"../constants\"\nexport function scanPlugin(deps: Set<string>): Plugin {\n  return {\n    name: \"esbuild:scan-deps\",\n    setup(build) {\n      // 忽略的文件\n      build.onResolve(\n        { filter: new RegExp(`\\\\.(${EXTERNAL_TYPES.join(\"|\")})$`) },\n        (resolveInfo) => {\n          return {\n            path: resolveInfo.path,\n            external: true,\n          }\n        }\n      )\n\n      // 记录三方依赖\n      build.onResolve({ filter: BARE_IMPORT_RE }, (resolveInfo) => {\n        const { path: id } = resolveInfo\n        deps.add(id)\n        return {\n          path: id,\n          external: true,\n        }\n      })\n    },\n  }\n}\n","import path from \"path\"\nimport { Loader, Plugin } from \"esbuild\"\n// 解析es模块import/export\nimport { init, parse } from \"es-module-lexer\"\n// node 路径解析\nimport resolve from \"resolve\"\nimport fs from \"fs-extra\"\nimport createDebug from \"debug\"\n\nimport { BARE_IMPORT_RE } from \"../constants\"\n\nconst debug = createDebug(\"dev\")\n\nexport function preBundlePlugin(deps: Set<string>): Plugin {\n  return {\n    name: \"esbuild:pre-bundle\",\n    setup(build) {\n      build.onResolve({ filter: BARE_IMPORT_RE }, (resolveInfo) => {\n        const { path: id, importer } = resolveInfo\n        // 如果没有导入者信息，就代表是入口\n        const isEntry = !importer\n\n        if (deps.has(id)) {\n          return isEntry\n            ? {\n                path: id,\n                namespace: \"dep\",\n              }\n            : {\n                path: resolve.sync(id, { basedir: process.cwd() }),\n              }\n        }\n      })\n\n      build.onLoad({ filter: /.*/, namespace: \"dep\" }, async (loadInfo) => {\n        await init\n\n        const id = loadInfo.path\n        const root = process.cwd()\n        const entryPath = resolve.sync(id, { basedir: root })\n        const code = await fs.readFile(entryPath, \"utf-8\")\n\n        const [imports, exports] = await parse(code)\n\n        // 代理模块\n        const proxyModule = []\n        // cjs\n        if (!imports.length && !exports.length) {\n          const res = require(entryPath)\n          const specifiers = Object.keys(res)\n          proxyModule.push(\n            `export { ${specifiers.join(\",\")} } from \"${entryPath}\"`,\n            `export default require(\"${entryPath}\")`\n          )\n        } else {\n          // esm\n          if (exports.includes(\"default\")) {\n            proxyModule.push(`import d from \"${entryPath}\";export default d`)\n          }\n\n          proxyModule.push(`import * from \"${entryPath}\"`)\n        }\n\n        debug(\"代理模块内容：%o\", proxyModule.join(\"\\n\"))\n\n        const loader = path.extname(entryPath).slice(1)\n\n        return {\n          loader: loader as Loader,\n          contents: proxyModule.join(\"\\n\"),\n          resolveDir: root,\n        }\n      })\n    },\n  }\n}\n"],"mappings":"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","names":[]}