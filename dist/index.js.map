{"version":3,"sources":["../src/node/cli.ts","../src/node/server/index.ts","../src/node/optimizer/index.ts","../src/node/constants.ts","../src/node/optimizer/scanPlugin.ts","../src/node/optimizer/preBundlePlugin.ts","../src/node/utils.ts","../src/node/plugins/assets.ts","../src/node/plugins/clientInject.ts","../src/node/plugins/css.ts","../src/node/plugins/esbuild.ts","../src/node/plugins/importAnalysis.ts","../src/node/plugins/resolve.ts","../src/node/plugins/index.ts","../src/node/pluginContainer.ts","../src/node/server/middlewares/indexHtml.ts","../src/node/server/middlewares/transform.ts","../src/node/server/middlewares/static.ts","../src/node/MoudleGraph.ts","../src/node/ws.ts","../src/node/hmr.ts"],"sourcesContent":["import cac from \"cac\"\n\nimport { startDevServer } from \"./server/index\"\n\nconst cli = cac()\n\ncli\n  .command(\"[root]\", \"Run the development server\")\n  .alias(\"serve\")\n  .alias(\"dev\")\n  .action(async () => {\n    await startDevServer()\n  })\n\ncli.help()\n\ncli.parse()\n","// connect是一个具有中间件的node框架\n// 可以作为服务器 也可以接入具有中间件的框架当中\nimport connect from 'connect'\n\n// 命令行着色工具\nimport { blue, green } from 'picocolors'\n\nimport chokidar, { FSWatcher } from 'chokidar'\n\nimport { optimizer } from '../optimizer/index'\n\nimport { Plugin } from '../plugin'\nimport { resolvePlugins } from '../plugins/index'\nimport { createPluginContainer, PluginContainer } from '../pluginContainer'\nimport { indexHtmlMiddleware } from './middlewares/indexHtml'\nimport { transformMiddleware } from './middlewares/transform'\nimport { staticMiddle } from './middlewares/static'\nimport { ModuleGraph } from '../MoudleGraph'\nimport { createWebSockerServer } from '../ws'\nimport { bindingHMREvents } from '../hmr'\n\nexport interface ServerContext {\n  root: string\n  pluginContainer: PluginContainer\n  app: connect.Server\n  plugins: Plugin[]\n  moduleGraph: ModuleGraph\n  ws: { send: (data: any) => void; close: () => void }\n  watcher: FSWatcher\n}\n\nexport async function startDevServer() {\n  const app = connect()\n  const root = process.cwd()\n  console.log('root', root)\n\n  const startTime = Date.now()\n\n  const plugins = resolvePlugins()\n  const pluginContainer = createPluginContainer(plugins)\n  const moduleGraph = new ModuleGraph((url) => pluginContainer.resolveId(url))\n\n  const watcher = chokidar.watch(root, {\n    ignored: ['**/node_modules/**', '**/.git/**'],\n    ignoreInitial: true\n  })\n\n  const ws = createWebSockerServer(app)\n\n  const serverContext: ServerContext = {\n    root: process.cwd(),\n    app,\n    pluginContainer,\n    plugins,\n    moduleGraph,\n    ws,\n    watcher\n  }\n\n  // 绑定热更新事件\n  bindingHMREvents(serverContext)\n\n  for (const plugin of plugins) {\n    if (plugin.configureServer) {\n      await plugin.configureServer(serverContext)\n    }\n  }\n\n  app.use(transformMiddleware(serverContext))\n  app.use(staticMiddle())\n  app.use(indexHtmlMiddleware(serverContext))\n  app.listen(3000, async () => {\n    await optimizer(root)\n\n    console.log(\n      green('No-Bundle Server start!'),\n      `耗时：${Date.now() - startTime}ms`\n    )\n\n    console.log(`本地访问路径：${blue('http://localhost:3000')}`)\n  })\n}\n","import path from \"path\"\nimport { build } from \"esbuild\"\n\nimport { green } from \"picocolors\"\nimport { scanPlugin } from \"./scanPlugin\"\nimport { PRE_BUNDLE_DIR } from \"../constants\"\nimport { preBundlePlugin } from \"./preBundlePlugin\"\n\nexport async function optimizer(root: string) {\n  // 1.确定入口\n  const entry = path.resolve(root, \"src/main.tsx\")\n\n  // 2.从入口扫描依赖\n  const deps = new Set<string>()\n\n  await build({\n    entryPoints: [entry],\n    bundle: true,\n    write: false,\n    plugins: [scanPlugin(deps)],\n  })\n\n  console.log(`\n  ${green(\"需要预构建的依赖\")}:\\n\n ${[...deps]\n   .map(green)\n   .map((item) => ` ${item}`)\n   .join(\"\\n\")}\n  `)\n\n  // 3.预构建依赖\n\n  await build({\n    entryPoints: [...deps],\n    write: true,\n    bundle: true,\n    format: \"esm\",\n    splitting: true,\n    outdir: path.resolve(root, PRE_BUNDLE_DIR),\n    plugins: [preBundlePlugin(deps)],\n  })\n}\n","import path from 'path'\n\n// 不处理\nexport const EXTERNAL_TYPES = [\n  'css',\n  'less',\n  'sass',\n  'scss',\n  'styl',\n  'stylus',\n  'pcss',\n  'postcss',\n  'vue',\n  'svelte',\n  'marko',\n  'astro',\n  'png',\n  'jpe?g',\n  'gif',\n  'svg',\n  'ico',\n  'webp',\n  'avif'\n]\n\n// 裸模块  就是没有绝对路径或者相对路径\nexport const BARE_IMPORT_RE = /^[\\w@][^:]/\n\n// 预构建存放的位置\nexport const PRE_BUNDLE_DIR = path.join('node_modules', '.m-vite')\n\nexport const JS_TYPES_RE = /\\.(?:j|t)sx?$|\\.mjs$/\nexport const QUERY_RE = /\\?.*$/s\nexport const HASH_RE = /#.*$/s\n\nexport const DEFAULT_EXTENSIONS = ['.ts', '.js', '.tsx', '.jsx']\n\nexport const HMR_PORT = 24678\n\nexport const CLIENT_PUBLIC_PATH = '/@vite/client'\n","import { Plugin } from \"esbuild\"\nimport { BARE_IMPORT_RE, EXTERNAL_TYPES } from \"../constants\"\nexport function scanPlugin(deps: Set<string>): Plugin {\n  return {\n    name: \"esbuild:scan-deps\",\n    setup(build) {\n      // 忽略的文件\n      build.onResolve(\n        { filter: new RegExp(`\\\\.(${EXTERNAL_TYPES.join(\"|\")})$`) },\n        (resolveInfo) => {\n          return {\n            path: resolveInfo.path,\n            external: true,\n          }\n        }\n      )\n\n      // 记录三方依赖\n      build.onResolve({ filter: BARE_IMPORT_RE }, (resolveInfo) => {\n        const { path: id } = resolveInfo\n        deps.add(id)\n        return {\n          path: id,\n          external: true,\n        }\n      })\n    },\n  }\n}\n","import path from \"path\"\nimport { Loader, Plugin } from \"esbuild\"\n// 解析es模块import/export\nimport { init, parse } from \"es-module-lexer\"\n// node 路径解析\nimport resolve from \"resolve\"\nimport fs from \"fs-extra\"\nimport createDebug from \"debug\"\n\nimport { BARE_IMPORT_RE } from \"../constants\"\n\nconst debug = createDebug(\"dev\")\n\nexport function preBundlePlugin(deps: Set<string>): Plugin {\n  return {\n    name: \"esbuild:pre-bundle\",\n    setup(build) {\n      build.onResolve({ filter: BARE_IMPORT_RE }, (resolveInfo) => {\n        const { path: id, importer } = resolveInfo\n        // 如果没有导入者信息，就代表是入口\n        const isEntry = !importer\n\n        if (deps.has(id)) {\n          return isEntry\n            ? {\n                path: id,\n                namespace: \"dep\",\n              }\n            : {\n                path: resolve.sync(id, { basedir: process.cwd() }),\n              }\n        }\n      })\n\n      build.onLoad({ filter: /.*/, namespace: \"dep\" }, async (loadInfo) => {\n        await init\n\n        const id = loadInfo.path\n        const root = process.cwd()\n        const entryPath = resolve.sync(id, { basedir: root })\n        const code = await fs.readFile(entryPath, \"utf-8\")\n\n        const [imports, exports] = await parse(code)\n\n        // 代理模块\n        const proxyModule = []\n        // cjs\n        if (!imports.length && !exports.length) {\n          const res = require(entryPath)\n          const specifiers = Object.keys(res)\n          proxyModule.push(\n            `export { ${specifiers.join(\",\")} } from \"${entryPath}\"`,\n            `export default require(\"${entryPath}\")`\n          )\n        } else {\n          // esm\n          if (exports.includes(\"default\")) {\n            proxyModule.push(`import d from \"${entryPath}\";export default d`)\n          }\n\n          proxyModule.push(`import * from \"${entryPath}\"`)\n        }\n\n        debug(\"代理模块内容：%o\", proxyModule.join(\"\\n\"))\n\n        const loader = path.extname(entryPath).slice(1)\n\n        return {\n          loader: loader as Loader,\n          contents: proxyModule.join(\"\\n\"),\n          resolveDir: root,\n        }\n      })\n    },\n  }\n}\n","import path from 'path'\n\nimport { HASH_RE, JS_TYPES_RE, QUERY_RE } from './constants'\n\nexport const isJsRequest = (id: string) => {\n  id = clearUrl(id)\n\n  if (JS_TYPES_RE.test(id)) {\n    return true\n  }\n\n  // 没有后缀 并且不是/结尾\n  if (!path.extname(id) && !id.endsWith('/')) {\n    return true\n  }\n\n  return false\n}\n\nexport const isCssRequest = (id: string): boolean =>\n  clearUrl(id).endsWith('.css')\n\nexport const isImportRequest = (id: string): boolean => id.endsWith('?import')\n\nexport function removeImportQuery(url: string) {\n  return url.replace(/\\?import$/, '')\n}\n\n/**\n * 去除查询和哈希\n *\n * @param url\n * @returns\n */\nexport const clearUrl = (url: string) => {\n  return url.replace(HASH_RE, '').replace(QUERY_RE, '')\n}\n\n\nexport function getShortName(file: string, root: string) {\n  // posix 跨平台\n  return file.startsWith(root + '/') ? path.posix.relative(root, file) : file\n}\n","import { Plugin } from \"../plugin\"\nimport { clearUrl, removeImportQuery } from \"../utils\"\n\nexport function assetPlugin(): Plugin {\n  return {\n    name: \"m-vite:asset\",\n    async load(id) {\n      const cleanedId = removeImportQuery(clearUrl(id))\n\n      if (cleanedId.endsWith(\".svg\")) {\n        return {\n          code: `export default \"${cleanedId}\"`,\n        }\n      }\n    },\n  }\n}\n","import fs from 'fs-extra'\nimport path from 'path'\n\nimport { CLIENT_PUBLIC_PATH, HMR_PORT } from '../constants'\nimport { Plugin } from '../plugin'\nimport { ServerContext } from '../server/index'\n\nexport function clientInjectPlugin(): Plugin {\n  let serverContext: ServerContext\n\n  return {\n    name: 'm-vite:client-inject',\n    configureServer(s) {\n      serverContext = s\n    },\n    resolveId(id) {\n      if (id === CLIENT_PUBLIC_PATH) {\n        return { id }\n      }\n      return null\n    },\n    async load(id) {\n      if (id === CLIENT_PUBLIC_PATH) {\n        const realPath = path.join(\n          serverContext.root,\n          'node_modules',\n          'mini-vite',\n          'dist',\n          'client.mjs'\n        )\n        const code = await fs.readFile(realPath, 'utf-8')\n\n        return {\n          code: code.replace('__HMR_PORT__', JSON.stringify(HMR_PORT))\n        }\n      }\n    },\n    transformHtml(raw) {\n      return raw.replace(\n        /(<head[^>]*>)/i,\n        `$1<script type=\"module\" src=\"${CLIENT_PUBLIC_PATH}\"></script>`\n      )\n    }\n  }\n}\n","import { readFile } from 'fs-extra'\nimport { CLIENT_PUBLIC_PATH } from '../constants'\n\nimport { Plugin } from '../plugin'\nimport { ServerContext } from '../server'\nimport { getShortName } from '../utils'\n\nexport function cssPlugin(): Plugin {\n  let servserContext: ServerContext\n  return {\n    name: 'm-vite:css',\n    configureServer(s) {\n      servserContext = s\n    },\n    load(id) {\n      if (id.endsWith('.css')) {\n        return readFile(id, 'utf-8')\n      }\n    },\n    async transform(code, id) {\n      if (id.endsWith('.css')) {\n        const jsContent = `\n          import { createHotContext as __vite__createHotContext } from \"${CLIENT_PUBLIC_PATH}\";\n          import.meta.hot = __vite__createHotContext(\"/${getShortName(\n            id,\n            servserContext.root\n          )}\");\n\n          import {updateStyle,removeStyle} from \"${CLIENT_PUBLIC_PATH}\";\n\n          const id = '${id}';\n          const css = \"${code.replace(/\\n/g, '')}\";\n\n          updateStyle(id,css);\n\n          import.meta.hot.accept();\n          export default css;\n          import.meta.hot.prune(()=> removeStyle(id));\n          `.trim()\n        return {\n          code: jsContent\n        }\n      }\n\n      return null\n    }\n  }\n}\n","import path from \"path\"\nimport esbuild from \"esbuild\"\nimport { readFile } from \"fs-extra\"\n\nimport { Plugin } from \"../plugin\"\nimport { isJsRequest } from \"../utils\"\n\nexport function esbuildTransformPlugin(): Plugin {\n  return {\n    name: \"m-vite:esbuild-transform\",\n    async load(id) {\n      if (isJsRequest(id)) {\n        try {\n          const code = await readFile(id, \"utf-8\")\n          return code\n        } catch (e) {\n          return null\n        }\n      }\n    },\n    async transform(code, id) {\n      if (isJsRequest(id)) {\n        const extname = path.extname(id).slice(1)\n\n        const { code: transformCode, map } = await esbuild.transform(code, {\n          target: \"esnext\",\n          format: \"esm\",\n          sourcemap: true,\n          loader: extname as \"js\" | \"ts\" | \"jsx\" | \"tsx\",\n        })\n\n        return {\n          code: transformCode,\n          map,\n        }\n      }\n\n      return null\n    },\n  }\n}\n","import { init, parse } from 'es-module-lexer'\nimport path from 'path'\nimport { pathExists } from 'fs-extra'\nimport resolve from 'resolve'\nimport MagicString from 'magic-string'\n\nimport {\n  BARE_IMPORT_RE,\n  DEFAULT_EXTENSIONS,\n  PRE_BUNDLE_DIR,\n  CLIENT_PUBLIC_PATH\n} from '../constants'\nimport { clearUrl, isJsRequest, getShortName } from '../utils'\nimport { ServerContext } from '../server/index'\nimport { Plugin } from '../plugin'\nimport { transform } from 'esbuild'\n\nexport function importAnalysisPlugin(): Plugin {\n  let serverContext: ServerContext\n\n  return {\n    name: 'm-vite:import-analysis',\n    configureServer(s) {\n      serverContext = s\n    },\n    async transform(code: string, id: string) {\n      if (!isJsRequest(id)) {\n        return null\n      }\n\n      await init\n\n      const [imports] = parse(code)\n      const ms = new MagicString(code)\n\n      const resolve = async (id: string, importer?: string) => {\n        const resolved = await this.resolve(id, importer)\n\n        if (!resolved) {\n          return\n        }\n\n        const cleanedId = clearUrl(resolved.id)\n        const mod = moduleGraph.getModuleById(cleanedId)\n        let resolvedId = `/${getShortName(resolved.id, serverContext.root)}`\n        if (mod && mod.lastHMRTimestamp > 0) {\n          resolvedId += '?t=' + mod.lastHMRTimestamp\n        }\n        return resolvedId\n      }\n\n      const { moduleGraph } = serverContext\n      const curMod = moduleGraph.getModuleById(id)!\n      const importedModules = new Set<string>()\n\n      for (const importInfo of imports) {\n        const { s: modStart, e: modEnd, n: modSource } = importInfo\n        if (!modSource) continue\n\n        // 静态资源\n        if (modSource.endsWith('.svg')) {\n          const resolveUrl = path.join(path.dirname(id), modSource)\n          // 打一个import 标记\n          ms.overwrite(modStart, modEnd, `${resolveUrl}?import`)\n          continue\n        }\n\n        // 三方库\n        if (BARE_IMPORT_RE.test(modSource)) {\n          const bundlePath = path.join(\n            serverContext.root,\n            PRE_BUNDLE_DIR,\n            `${modSource}.js`\n          )\n          importedModules.add(bundlePath)\n          ms.overwrite(modStart, modEnd, bundlePath)\n        }\n        // 项目里面的文件\n        else if (modSource.startsWith('.') || modSource.startsWith('/')) {\n          const resolved = await resolve(modSource, id)\n          if (resolved) {\n            ms.overwrite(modStart, modEnd, resolved)\n            importedModules.add(resolved)\n          }\n        }\n      }\n\n      if (!id.includes('node_modules') && id !== CLIENT_PUBLIC_PATH) {\n        ms.prepend(\n          `import { createHotContext as __vite__createHotContext } from \"${CLIENT_PUBLIC_PATH}\";` +\n            `import.meta.hot = __vite__createHotContext(${JSON.stringify(\n              clearUrl(curMod.url)\n            )});`\n        )\n      }\n\n      moduleGraph.updateModuleInfo(curMod, importedModules)\n\n      return {\n        code: ms.toString(),\n        map: ms.generateMap()\n      }\n    }\n  }\n}\n","import resolve from \"resolve\"\nimport path from \"path\"\nimport { pathExists } from \"fs-extra\"\n\nimport { Plugin } from \"../plugin\"\nimport { ServerContext } from \"../server\"\nimport { clearUrl } from \"../utils\"\nimport { DEFAULT_EXTENSIONS } from \"../constants\"\n\nexport function resolvePlugin(): Plugin {\n  let serverContext: ServerContext\n\n  return {\n    name: \"m-vite:resolve\",\n    configureServer(s) {\n      serverContext = s\n    },\n    async resolveId(id: string, importer?: string) {\n      // 绝对路径\n      if (path.isAbsolute(id)) {\n        if (await pathExists(id)) {\n          return { id }\n        }\n\n        // 如果上面不能匹配\n        // 加上root，检测是不是在项目里\n\n        id = path.join(serverContext.root, id)\n        if (await pathExists(id)) {\n          return { id }\n        }\n      }\n      // 相对路径\n      else if (id.startsWith(\".\")) {\n        if (!importer) {\n          throw new Error(\"`importer` should not be undefined\")\n        }\n\n        const hasExtension = path.extname(id).length > 1\n\n        let resolveId: string\n\n        // 有后缀\n        if (hasExtension) {\n          resolveId = resolve.sync(id, { basedir: path.dirname(importer) })\n          if (await pathExists(resolveId)) {\n            return { id: resolveId }\n          }\n        } else {\n          // 没有后缀 用默认的后缀来解析\n          for (const extname of DEFAULT_EXTENSIONS) {\n            try {\n              const withExtension = `${id}${extname}`\n              resolveId = resolve.sync(withExtension, {\n                basedir: path.dirname(importer),\n              })\n\n              if (await pathExists(resolveId)) {\n                return { id: resolveId }\n              }\n            } catch (error) {\n              continue\n            }\n          }\n        }\n      }\n\n      return null\n    },\n  }\n}\n","import { Plugin } from '../plugin'\nimport { assetPlugin } from './assets'\nimport { clientInjectPlugin } from './clientInject'\nimport { cssPlugin } from './css'\n\nimport { esbuildTransformPlugin } from './esbuild'\nimport { importAnalysisPlugin } from './importAnalysis'\nimport { resolvePlugin } from './resolve'\n\nexport function resolvePlugins(): Plugin[] {\n  return [\n    clientInjectPlugin(),\n    resolvePlugin(),\n    esbuildTransformPlugin(),\n    importAnalysisPlugin(),\n    cssPlugin(),\n    assetPlugin()\n  ]\n}\n","import type {\n  LoadResult,\n  PartialResolvedId,\n  SourceDescription,\n  PluginContext as RollupPluginContext,\n  ResolvedId,\n} from \"rollup\"\n\nimport { Plugin } from \"./plugin\"\n\nexport interface PluginContainer {\n  resolveId(id: string, importer?: string): Promise<PartialResolvedId | null>\n  load(id: string): Promise<LoadResult | null>\n  transform(code: string, id: string): Promise<SourceDescription | null>\n}\n\nexport const createPluginContainer = (plugins: Plugin[]): PluginContainer => {\n  // @ts-ignore\n  class Context implements RollupPluginContext {\n    async resolve(id: string, importer?: string) {\n      let out = await pluginContainer.resolveId(id, importer)\n\n      // 如果有返回string 就认为是一个新id\n      if (typeof out === \"string\") {\n        out = { id: out }\n      }\n      return out as ResolvedId | null\n    }\n  }\n\n  const pluginContainer: PluginContainer = {\n    async resolveId(id: string, importer?: string) {\n      const ctx = new Context() as any\n      for (const plugin of plugins) {\n        if (plugin.resolveId) {\n          const newId = await plugin.resolveId.call(ctx, id, importer)\n          if (newId) {\n            id = typeof newId === \"string\" ? newId : newId.id\n            return { id }\n          }\n        }\n      }\n      return null\n    },\n\n    async load(id) {\n      const ctx = new Context() as any\n      for (const plugin of plugins) {\n        if (plugin.load) {\n          const result = await plugin.load.call(ctx, id)\n          if (result) {\n            return result\n          }\n        }\n      }\n      return null\n    },\n\n    async transform(code, id) {\n      const ctx = new Context() as any\n      for (const plugin of plugins) {\n        if (plugin.transform) {\n          const result = await plugin.transform.call(ctx, code, id)\n          if (!result) continue\n\n          if (typeof result === \"string\") {\n            code = result\n          } else if (result.code) {\n            code = result.code\n          }\n        }\n      }\n      return { code }\n    },\n  }\n\n  return pluginContainer\n}\n","import { NextHandleFunction } from \"connect\"\nimport path from \"path\"\nimport { fstat, pathExists, readFile } from \"fs-extra\"\n\nimport { ServerContext } from \"../index\"\n\nexport function indexHtmlMiddleware(\n  serverContext: ServerContext\n): NextHandleFunction {\n  return async (req, res, next) => {\n    if (req.url === \"/\") {\n      const { root } = serverContext\n      // 默认使用根目录下的index.html\n      const indexHtmlPath = path.join(root, \"index.html\")\n\n      if (await pathExists(indexHtmlPath)) {\n        const rawHtml = await readFile(indexHtmlPath, \"utf-8\")\n\n        let html: any = rawHtml\n\n        for (const plugin of serverContext.plugins) {\n          if (plugin.transformHtml) {\n            html = plugin.transformHtml(html)\n          }\n        }\n\n        res.statusCode = 200\n        res.setHeader(\"Content-Type\", \"text/html\")\n\n        return res.end(html)\n      }\n    }\n    return next()\n  }\n}\n","import { NextHandleFunction } from 'connect'\nimport createDebug from 'debug'\n\nimport {\n  isJsRequest,\n  isCssRequest,\n  clearUrl,\n  isImportRequest\n} from '../../utils'\nimport { ServerContext } from '../index'\n\nconst debug = createDebug('dev')\n\nexport async function transformRequest(\n  url: string,\n  serverContext: ServerContext\n) {\n  const { pluginContainer, moduleGraph } = serverContext\n\n  url = clearUrl(url)\n  let mod = moduleGraph.getModuleByUrl(url)\n\n  // 如果存在缓存的结果 就直接返回\n  if (mod && mod.transformResult) {\n    return mod.transformResult\n  }\n\n  // 依次调用 resolveId load transform\n  const resolvedResult = await pluginContainer.resolveId(url)\n  let transformResult: any\n  if (resolvedResult?.id) {\n    let code = await pluginContainer.load(resolvedResult.id)\n    if (typeof code === 'object' && code != null) {\n      code = code.code\n    }\n    // 注册模块\n    mod = await moduleGraph.ensureEntryFromUrl(url)\n    if (code) {\n      transformResult = await pluginContainer.transform(code, resolvedResult.id)\n    }\n  }\n\n  if(mod){\n    mod.transformResult = transformResult\n  }\n  return transformResult\n}\n\nexport function transformMiddleware(\n  serverContext: ServerContext\n): NextHandleFunction {\n  return async (req, res, next) => {\n    if (req.method !== 'GET' || !req.url) {\n      return next()\n    }\n\n    const url = req.url\n\n    debug('transformMiddleware:s%', url)\n\n    if (isJsRequest(url) || isCssRequest(url) || isImportRequest(url)) {\n      let result = await transformRequest(url, serverContext)\n\n      if (!result) {\n        return next()\n      }\n\n      if (result && typeof result !== 'string') {\n        result = result.code\n      }\n\n      res.statusCode = 200\n      res.setHeader('Content-Type', 'application/javascript')\n      res.end(result)\n    }\n\n    next()\n  }\n}\n","import { NextHandleFunction } from \"connect\"\n// 用于加载静态资源的中间件\nimport sirv from \"sirv\"\n\nimport { isImportRequest } from \"../../utils\"\n\nexport function staticMiddle(): NextHandleFunction {\n  const serveFromRoot = sirv(\"/\", { dev: true })\n\n  return (req, res, next) => {\n    const url = req.url\n\n    if (!url) {\n      return\n    }\n\n    if (isImportRequest(url)) {\n      return\n    }\n\n    serveFromRoot(req, res, next)\n  }\n}\n","import { PartialResolvedId, TransformResult } from \"rollup\";\n\nimport { clearUrl } from \"./utils\";\n\nexport class ModuleNode {\n  id: string | null = null;\n\n  // 哪些模块引用了当前模块\n  importers = new Set<ModuleNode>();\n  // 当前模块所依赖的模块\n  importedModules = new Set<ModuleNode>();\n  transformResult: TransformResult | null = null;\n  lastHMRTimestamp = 0;\n\n  constructor(public url: string) {}\n}\n\nexport class ModuleGraph {\n  urlToModuleMap = new Map<string, ModuleNode>();\n  idToModuleMap = new Map<string, ModuleNode>();\n\n  constructor(\n    private resolveId: (url: string) => Promise<PartialResolvedId | null>\n  ) {}\n\n  getModuleById(id: string): ModuleNode | undefined {\n    return this.idToModuleMap.get(id);\n  }\n\n  getModuleByUrl(url: string): ModuleNode | undefined {\n    return this.urlToModuleMap.get(url);\n  }\n\n  // 确定模块\n  async ensureEntryFromUrl(rawUrl: string): Promise<ModuleNode> {\n    const { url, resolveId } = await this._resolve(rawUrl);\n\n    if (this.urlToModuleMap.has(url)) {\n      return this.urlToModuleMap.get(url) as ModuleNode;\n    }\n\n    const mod = new ModuleNode(url);\n    mod.id = resolveId;\n    this.urlToModuleMap.set(url, mod);\n    this.idToModuleMap.set(resolveId, mod);\n\n    return mod;\n  }\n\n  async updateModuleInfo(\n    mod: ModuleNode,\n    importedModules: Set<string | ModuleNode>\n  ) {\n    const prevImports = mod.importedModules;\n\n    for (const curImports of importedModules) {\n      // 获取依赖key\n      const dep =\n        typeof curImports === \"string\"\n          ? await this.ensureEntryFromUrl(clearUrl(curImports))\n          : curImports;\n\n      if (dep) {\n        mod.importedModules.add(dep);\n        dep.importers.add(mod);\n      }\n    }\n\n    // 移除不需要的依赖\n    for (const prevImport of prevImports) {\n      if (!importedModules.has(prevImport.url)) {\n        prevImport.importers.delete(mod);\n      }\n    }\n  }\n\n  // 热更新调用\n  invalidateModule(file: string) {\n    const mod = this.idToModuleMap.get(file);\n    if (mod) {\n      mod.lastHMRTimestamp = Date.now();\n      mod.transformResult = null;\n      mod.importers.forEach((importer) => {\n        this.invalidateModule(importer.url);\n      });\n    }\n  }\n\n  private async _resolve(\n    url: string\n  ): Promise<{ url: string; resolveId: string }> {\n    const resolved = await this.resolveId(url);\n    const resolveId = resolved?.id || url;\n    return { url, resolveId };\n  }\n}\n","import connect from 'connect'\nimport { red } from 'picocolors'\nimport { WebSocket, WebSocketServer } from 'ws'\nimport { HMR_PORT } from './constants'\n\nexport function createWebSockerServer(server:connect.Server):{\n  send:(msg:string) => void,\n  close:()=>void\n} {\n\n  let wss: WebSocketServer\n\n  wss = new WebSocketServer({port:HMR_PORT})\n\n  wss.on('connection', (socker)=>{\n    socker.send(JSON.stringify({type:'connected'}))\n  })\n\n  wss.on('error', (e:Error & {code:string})=>{\n    if(e.code !== 'EADDRINUSE'){\n       console.error(red(`WebSocket server error:\\n${e.stack || e.message}`));\n    }\n  })\n\n\n  return {\n    send(payload:Object){\n      const stringified = JSON.stringify(payload)\n      wss.clients.forEach(client=>{\n        if(client.readyState === WebSocket.OPEN){\n          client.send(stringified)\n        }\n      })\n    },\n    close(){\n      wss.close()\n    }\n  }\n}\n","import { ServerContext } from './server/index'\nimport { blue, green } from 'picocolors'\n\nimport { getShortName } from './utils'\n\nexport function bindingHMREvents(serverContext: ServerContext) {\n  const { watcher, ws, root, moduleGraph } = serverContext\n\n  watcher.on('change', async (file) => {\n    console.log(`✨${blue('[hmr]')} ${green(file)} changed`)\n    moduleGraph.invalidateModule(file)\n\n    ws.send({\n      type: 'update',\n      updates: [\n        {\n          type: 'js-update',\n          timestamp: Date.now(),\n          path: '/' + getShortName(file, root),\n          acceptedPath: '/' + getShortName(file, root)\n        }\n      ]\n    })\n  })\n}\n"],"mappings":"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","names":[]}