{"version":3,"sources":["../src/node/cli.ts","../src/node/server/index.ts","../src/node/optimizer/index.ts","../src/node/constants.ts","../src/node/optimizer/scanPlugin.ts","../src/node/optimizer/preBundlePlugin.ts","../src/node/plugins/index.ts","../src/node/pluginContainer.ts"],"sourcesContent":["import cac from \"cac\"\n\nimport { startDevServer } from \"./server/index\"\n\nconst cli = cac()\n\ncli\n  .command(\"[root]\", \"Run the development server\")\n  .alias(\"serve\")\n  .alias(\"dev\")\n  .action(async () => {\n    await startDevServer()\n  })\n\ncli.help()\n\ncli.parse()\n","// connect是一个具有中间件的node框架\n// 可以作为服务器 也可以接入具有中间件的框架当中\nimport connect from \"connect\"\n\n// 命令行着色工具\nimport { blue, green } from \"picocolors\"\n\nimport { optimizer } from \"../optimizer/index\"\n\nimport { Plugin } from \"../plugin\"\nimport { resolvePlugins } from \"../plugins/index\"\nimport { createPluginContainer, PluginContainer } from \"../pluginContainer\"\n\nexport interface ServerContext {\n  root: string\n  pluginContainer: PluginContainer\n  app: connect.Server\n  plugins: Plugin[]\n}\n\nexport async function startDevServer() {\n  const app = connect()\n  const root = process.cwd()\n  console.log(\"root\", root)\n\n  const startTime = Date.now()\n\n  const plugins = resolvePlugins()\n  const pluginContainer = createPluginContainer(plugins)\n\n  const serverContext: ServerContext = {\n    root: process.cwd(),\n    app,\n    pluginContainer,\n    plugins,\n  }\n\n  for (const plugin of plugins) {\n    if (plugin.configureServer) {\n      await plugin.configureServer(serverContext)\n    }\n  }\n\n  app.listen(3000, async () => {\n    await optimizer(root)\n\n    console.log(\n      green(\"No-Bundle Server start!\"),\n      `耗时：${Date.now() - startTime}ms`\n    )\n\n    console.log(`本地访问路径：${blue(\"http://localhost:3000\")}`)\n  })\n}\n","import path from \"path\"\nimport { build } from \"esbuild\"\n\nimport { green } from \"picocolors\"\nimport { scanPlugin } from \"./scanPlugin\"\nimport { PRE_BUNDLE_DIR } from \"../constants\"\nimport { preBundlePlugin } from \"./preBundlePlugin\"\n\nexport async function optimizer(root: string) {\n  // 1.确定入口\n  const entry = path.resolve(root, \"src/main.tsx\")\n\n  // 2.从入口扫描依赖\n  const deps = new Set<string>()\n\n  await build({\n    entryPoints: [entry],\n    bundle: true,\n    write: false,\n    plugins: [scanPlugin(deps)],\n  })\n\n  console.log(`\n  ${green(\"需要预构建的依赖\")}:\\n\n ${[...deps]\n   .map(green)\n   .map((item) => ` ${item}`)\n   .join(\"\\n\")}\n  `)\n\n  // 3.预构建依赖\n\n  await build({\n    entryPoints: [...deps],\n    write: true,\n    bundle: true,\n    format: \"esm\",\n    splitting: true,\n    outdir: path.resolve(root, PRE_BUNDLE_DIR),\n    plugins: [preBundlePlugin(deps)],\n  })\n}\n","import path from \"path\"\n\n// 不处理\nexport const EXTERNAL_TYPES = [\n  \"css\",\n  \"less\",\n  \"sass\",\n  \"scss\",\n  \"styl\",\n  \"stylus\",\n  \"pcss\",\n  \"postcss\",\n  \"vue\",\n  \"svelte\",\n  \"marko\",\n  \"astro\",\n  \"png\",\n  \"jpe?g\",\n  \"gif\",\n  \"svg\",\n  \"ico\",\n  \"webp\",\n  \"avif\",\n]\n\n// 裸模块  就是没有绝对路径或者相对路径\nexport const BARE_IMPORT_RE = /^[\\w@][^:]/\n\n// 预构建存放的位置\nexport const PRE_BUNDLE_DIR = path.join(\"node_modules\", \".m-vite\")\n","import { Plugin } from \"esbuild\"\nimport { BARE_IMPORT_RE, EXTERNAL_TYPES } from \"../constants\"\nexport function scanPlugin(deps: Set<string>): Plugin {\n  return {\n    name: \"esbuild:scan-deps\",\n    setup(build) {\n      // 忽略的文件\n      build.onResolve(\n        { filter: new RegExp(`\\\\.(${EXTERNAL_TYPES.join(\"|\")})$`) },\n        (resolveInfo) => {\n          return {\n            path: resolveInfo.path,\n            external: true,\n          }\n        }\n      )\n\n      // 记录三方依赖\n      build.onResolve({ filter: BARE_IMPORT_RE }, (resolveInfo) => {\n        const { path: id } = resolveInfo\n        deps.add(id)\n        return {\n          path: id,\n          external: true,\n        }\n      })\n    },\n  }\n}\n","import path from \"path\"\nimport { Loader, Plugin } from \"esbuild\"\n// 解析es模块import/export\nimport { init, parse } from \"es-module-lexer\"\n// node 路径解析\nimport resolve from \"resolve\"\nimport fs from \"fs-extra\"\nimport createDebug from \"debug\"\n\nimport { BARE_IMPORT_RE } from \"../constants\"\n\nconst debug = createDebug(\"dev\")\n\nexport function preBundlePlugin(deps: Set<string>): Plugin {\n  return {\n    name: \"esbuild:pre-bundle\",\n    setup(build) {\n      build.onResolve({ filter: BARE_IMPORT_RE }, (resolveInfo) => {\n        const { path: id, importer } = resolveInfo\n        // 如果没有导入者信息，就代表是入口\n        const isEntry = !importer\n\n        if (deps.has(id)) {\n          return isEntry\n            ? {\n                path: id,\n                namespace: \"dep\",\n              }\n            : {\n                path: resolve.sync(id, { basedir: process.cwd() }),\n              }\n        }\n      })\n\n      build.onLoad({ filter: /.*/, namespace: \"dep\" }, async (loadInfo) => {\n        await init\n\n        const id = loadInfo.path\n        const root = process.cwd()\n        const entryPath = resolve.sync(id, { basedir: root })\n        const code = await fs.readFile(entryPath, \"utf-8\")\n\n        const [imports, exports] = await parse(code)\n\n        // 代理模块\n        const proxyModule = []\n        // cjs\n        if (!imports.length && !exports.length) {\n          const res = require(entryPath)\n          const specifiers = Object.keys(res)\n          proxyModule.push(\n            `export { ${specifiers.join(\",\")} } from \"${entryPath}\"`,\n            `export default require(\"${entryPath}\")`\n          )\n        } else {\n          // esm\n          if (exports.includes(\"default\")) {\n            proxyModule.push(`import d from \"${entryPath}\";export default d`)\n          }\n\n          proxyModule.push(`import * from \"${entryPath}\"`)\n        }\n\n        debug(\"代理模块内容：%o\", proxyModule.join(\"\\n\"))\n\n        const loader = path.extname(entryPath).slice(1)\n\n        return {\n          loader: loader as Loader,\n          contents: proxyModule.join(\"\\n\"),\n          resolveDir: root,\n        }\n      })\n    },\n  }\n}\n","import { Plugin } from \"../plugin\"\n\nexport function resolvePlugins(): Plugin[] {\n  return []\n}\n","import type {\n  LoadResult,\n  PartialResolvedId,\n  SourceDescription,\n  PluginContext as RollupPluginContext,\n  ResolvedId,\n} from \"rollup\"\n\nimport { Plugin } from \"./plugin\"\n\nexport interface PluginContainer {\n  resolveId(id: string, importer?: string): Promise<PartialResolvedId | null>\n  load(id: string): Promise<LoadResult | null>\n  transform(code: string, id: string): Promise<SourceDescription | null>\n}\n\nexport const createPluginContainer = (plugins: Plugin[]): PluginContainer => {\n  // @ts-ignore\n  class Context implements RollupPluginContext {\n    async resolve(id: string, importer?: string) {\n      let out = await pluginContainer.resolveId(id, importer)\n\n      // 如果有返回string 就认为是一个新id\n      if (typeof out === \"string\") {\n        out = { id: out }\n      }\n      return out as ResolvedId | null\n    }\n  }\n\n  const pluginContainer: PluginContainer = {\n    async resolveId(id: string, importer?: string) {\n      const ctx = new Context() as any\n      for (const plugin of plugins) {\n        if (plugin.resolved) {\n          const newId = await plugin.resolved.call(ctx, id, importer)\n          if (newId) {\n            id = typeof newId === \"string\" ? newId : newId.id\n            return { id }\n          }\n        }\n      }\n      return null\n    },\n\n    async load(id) {\n      const ctx = new Context() as any\n      for (const plugin of plugins) {\n        if (plugin.load) {\n          const result = await plugin.load.call(ctx, id)\n          if (result) {\n            return result\n          }\n        }\n      }\n      return null\n    },\n\n    async transform(code, id) {\n      const ctx = new Context() as any\n      for (const plugin of plugins) {\n        if (plugin.transform) {\n          const result = await plugin.transform.call(ctx, code, id)\n          if (!result) continue\n\n          if (typeof result === \"string\") {\n            code = result\n          } else if (result.code) {\n            code = result.code\n          }\n        }\n      }\n      return { code }\n    },\n  }\n\n  return pluginContainer\n}\n"],"mappings":"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","names":[]}